#include "stm32f4xx.h"
#include "misc.h"
#include "stm32f4xx_rcc.h"
#include "stm32f4xx_gpio.h"
#include "stm32f4xx_tim.h"
#include "stm32f4xx_usart.h"
#include "stm32f4xx_dma.h"
#include "string.h"



/* Create USART working buffer */
char USART_Buffer[100] = "Hello via USART2 with TX DMA\n";

int main(void) {
    /* Initialize system */
    SystemInit();

    /* Init USART2 on pins TX = PA2, RX = PA3 */
    /* This pins are used on Nucleo boards for USB to UART via ST-Link */
    TM_USART_Init(USART2, TM_USART_PinsPack_1, 115200);

    /* Init TX DMA for USART2 */
    TM_USART_DMA_Init(USART2);

    /* Say string without DMA */
    TM_USART_Puts(USART2, "Hello via USART2 without DMA\n");

    /* Send data with DMA */
    TM_USART_DMA_Send(USART2, (uint8_t *)USART_Buffer, strlen(USART_Buffer));

    /* Wait till DMA works */
    /* You can do other stuff here instead of waiting for DMA to end */
    while (TM_USART_DMA_Sending(USART2));

    while (1) {
        /* If any string arrived over USART */
        /* Expecting "\n" at the end of string from USART terminal or any other source */
        if (TM_USART_Gets(USART2, USART_Buffer, sizeof(USART_Buffer))) {
            /* Send it back over DMA */
            TM_USART_DMA_Send(USART2, (uint8_t *)USART_Buffer, strlen(USART_Buffer));

            /* Wait till DMA works */
            /* You can do other stuff here instead of waiting for DMA to end */
            while (TM_USART_DMA_Sending(USART2));
        }
    }
}
